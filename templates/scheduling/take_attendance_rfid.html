{% extends 'base.html' %}
{% load static %}

{% block title %}Take Attendance with RFID{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Take Attendance with RFID</h1>
        <div>
            <a href="{% url 'take_attendance' schedule.id %}" class="btn btn-secondary btn-sm shadow-sm mr-2">
                <i class="fas fa-list fa-sm text-white-50"></i> Manual Attendance
            </a>
            <a href="{% url 'schedule_list' %}" class="btn btn-secondary btn-sm shadow-sm">
                <i class="fas fa-arrow-left fa-sm text-white-50"></i> Back to Schedule
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Scan RFID Card</h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-id-card fa-4x mb-3 text-primary"></i>
                        <h5>Please scan student's RFID card</h5>
                    </div>

                    <form method="post" id="rfidForm" autocomplete="off">
                        {% csrf_token %}
                        <div class="form-group">
                            {{ form.rfid_uid.label_tag }}
                            {{ form.rfid_uid }}
                            {% if form.rfid_uid.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.rfid_uid.errors }}
                                </div>
                            {% endif %}
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Record Attendance</button>
                    </form>
                </div>
                <div class="card-footer">
                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                        Attendance Summary
                    </div>
                    <div class="row no-gutters align-items-center mt-2">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-gray-800">Recorded: {{ recorded_count }}/{{ total_students }}</div>
                            <div class="progress progress-sm mr-2 mb-2">
                                <div class="progress-bar bg-info" role="progressbar" style="width: {% widthratio recorded_count total_students 100 %}%" aria-valuenow="{{ recorded_count }}" aria-valuemin="0" aria-valuemax="{{ total_students }}"></div>
                            </div>
                            <div class="text-xs font-weight-bold text-gray-800">Students with RFID: {{ students_with_rfid }}/{{ total_students }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">
                        Attendance for {{ schedule.subject.name }} ({{ schedule.get_day_display }} {{ schedule.start_time|time:"g:i A" }} - {{ schedule.end_time|time:"g:i A" }})
                    </h6>
                    <span class="badge badge-primary">{{ date|date:"F d, Y" }}</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="attendanceTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Time Recorded</th>
                                    <th>RFID Card</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in student_attendance %}
                                <tr class="{% if item.status == 'Present' %}table-success{% elif item.status == 'Absent' %}table-danger{% elif item.status == 'Late' %}table-warning{% else %}table-secondary{% endif %}">
                                    <td>{{ item.student.student_id }}</td>
                                    <td>{{ item.student.first_name }} {{ item.student.last_name }}</td>
                                    <td>
                                        <span class="badge {% if item.status == 'Present' %}bg-success{% elif item.status == 'Absent' %}bg-danger{% elif item.status == 'Late' %}bg-warning{% else %}bg-secondary{% endif %}">
                                            {{ item.status }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if item.timestamp %}
                                            <small class="text-muted">{{ item.timestamp|time:"g:i:s A" }}</small>
                                        {% else %}
                                            <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.has_rfid %}
                                            <span class="badge bg-success"><i class="fas fa-check"></i> Registered</span>
                                        {% else %}
                                            <span class="badge bg-danger"><i class="fas fa-times"></i> Not Registered</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center">No students enrolled in this subject.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- SweetAlert2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.min.css" rel="stylesheet" type="text/css">
{% endblock %}

{% block extra_js %}
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.all.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Focus on the RFID input field when the page loads
        const rfidInput = document.getElementById('{{ form.rfid_uid.id_for_label }}');
        rfidInput.focus();
        
        // Handle form submission with AJAX to detect double taps
        const rfidForm = document.getElementById('rfidForm');
        rfidForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Only proceed if the RFID input has a value
            if (rfidInput.value.trim().length > 0) {
                const formData = new FormData(rfidForm);
                
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    // Check if response is JSON
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json();
                    }
                    // If not JSON, it's a regular form submission response, reload the page
                    window.location.reload();
                    return null;
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Reload the page on error
                    window.location.reload();
                })
                .then(data => {
                    console.log('Response data:', data); // Debug the response
                    
                    if (data && data.is_double_tap) {
                        // Show SweetAlert for double tap
                        Swal.fire({
                            title: 'Already Marked Present',
                            html: `
                                <div class="text-center">
                                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                                    <p>${data.message}</p>
                                    <p class="text-muted">First recorded at: ${data.timestamp}</p>
                                </div>
                            `,
                            icon: 'warning',
                            confirmButtonColor: '#f6c23e',
                            confirmButtonText: 'OK'
                        });
                        
                        // Clear the input field and focus it again
                        rfidInput.value = '';
                        rfidInput.focus();
                    } else if (data && data.status === 'success') {
                        // Show success message
                        Swal.fire({
                            title: 'Success!',
                            text: data.message,
                            icon: 'success',
                            confirmButtonColor: '#3085d6',
                            confirmButtonText: 'OK',
                            timer: 1500,
                            timerProgressBar: true
                        });
                        
                        // Update the attendance table without refreshing the page
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                        
                        // Clear the input field and focus it again
                        rfidInput.value = '';
                        rfidInput.focus();
                    } else if (data && data.status === 'error') {
                        // Show other errors
                        Swal.fire({
                            title: 'Error',
                            text: data.message,
                            icon: 'error',
                            confirmButtonColor: '#3085d6',
                            confirmButtonText: 'OK'
                        });
                        
                        // Clear the input field and focus it again
                        rfidInput.value = '';
                        rfidInput.focus();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Reload the page on error
                    window.location.reload();
                });
                
                // Clear the input field after submission
                rfidInput.value = '';
            }
        });
        
        // Auto-submit when an RFID card is scanned
        rfidInput.addEventListener('input', function(e) {
            // If the input is long enough to be a complete RFID, submit the form
            if (this.value.length >= 8) {
                setTimeout(() => {
                    rfidForm.dispatchEvent(new Event('submit'));
                }, 500); // Small delay to ensure the full code is captured
            }
        });
        
        // Clear any messages after 3 seconds
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                alert.style.transition = 'opacity 1s';
                alert.style.opacity = '0';
                setTimeout(function() {
                    alert.remove();
                }, 1000);
            });
        }, 3000);
    });
</script>
{% endblock %}
